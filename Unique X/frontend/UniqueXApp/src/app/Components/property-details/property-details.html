@if (property(); as prop) {
<div class="container py-4">
  
  <!-- 1. معرض الصور (Grid Gallery) -->
  <div class="row g-2 gallery-grid shadow-sm rounded-4 overflow-hidden mb-5">
    
    <!-- الصورة الكبيرة -->
    <div class="col-md-8 position-relative main-photo-container" (click)="openGallery(0)" style="cursor: pointer;">
      <img [src]="prop.photos[0]?.url" class="transition-hover" alt="Main View">
      
      <div class="camera-btn position-absolute bottom-0 start-0 m-3 bg-white text-dark px-3 py-1 rounded-2 shadow-sm fw-bold border">
        <i class="bi bi-camera-fill me-1 text-danger"></i> {{ prop.photos.length }} Photos
      </div>
    </div>

    <!-- الصور الجانبية -->
    <div class="col-md-4 d-none d-md-flex flex-column gap-2">
      <div class="side-photo-container overflow-hidden" (click)="openGallery(1)" style="cursor: pointer;">
        <img [src]="prop.photos[1]?.url || prop.photos[0]?.url" class="transition-hover">
      </div>

      <div class="side-photo-container overflow-hidden position-relative" (click)="openGallery(2)" style="cursor: pointer;">
        <img [src]="prop.photos[2]?.url || prop.photos[0]?.url" class="transition-hover">
        @if(prop.photos.length > 3) {
          <div class="overlay-more d-flex align-items-center justify-content-center text-white fw-bold fs-5">
            +{{ prop.photos.length - 3 }} More
          </div>
        }
      </div>
    </div>
  </div>

  <!-- 2. قسم البيانات (أضفنا mt-5 لضمان عدم التداخل) -->
  <div class="row g-4 mt-5">
    
    <div class="col-lg-8">
      <!-- كارت المعلومات الأساسية -->
      <div class="bg-white p-4 rounded-4 shadow-sm mb-4 border border-light">
        
        <!-- العنوان (Title) - الآن واضح وتحت الصور بمسافة مريحة -->
        <h2 class="fw-bold text-dark mb-2">
            {{ prop.title }} 
             @if (prop.projectName) {
    <h4 class="text-danger fw-bold mb-3 d-flex align-items-center animate__animated animate__fadeIn">
      <i class="bi bi-building-fill-check me-2"></i>
      <span>{{ prop.projectName }}</span>
    </h4>
  } 
      @if (prop.code) { <h6 class="text-dark fs-6 fw-normal ms-2">{{ prop.code }}</h6> }
        </h2>
        
         <div class="d-flex align-items-center gap-3 mb-3">
            @if (prop.listingType === 'Rent') {
                <h3 class="fw-bold text-danger mb-0">EGP {{ prop.monthlyRent | number }} <small class="fs-6 text-muted fw-normal">/ month</small></h3>
            } @else {
                <h3 class="fw-bold text-danger mb-0">EGP {{ prop.price | number }}</h3>
            }
            <span class="badge bg-danger rounded-pill px-3 py-2 fw-bold small shadow-sm">{{ prop.listingType }}</span>
        </div>

        <p class="text-muted small mb-4">
            <i class="bi bi-geo-alt-fill text-danger me-2"></i>{{ prop.region }}, {{ prop.city }}
        </p>
        
        <!-- الأيقونات (Beds, Baths, etc.) -->
        <div class="d-flex gap-4 border-top border-bottom py-3 my-4 justify-content-around text-center bg-light-subtle rounded-3">
          @if (prop.rooms > 0) {
    <div><i class="bi bi-door-open fs-4 d-block text-danger"></i> <span class="fw-bold">{{ prop.rooms }}</span> <small class="text-muted d-block small">Beds</small></div>
  }

  <!-- لا يظهر إلا إذا كان عدد الحمامات أكبر من 0 -->
  @if (prop.bathrooms > 0) {
    <div><i class="bi bi-droplet fs-4 d-block text-danger"></i> <span class="fw-bold">{{ prop.bathrooms }}</span> <small class="text-muted d-block small">Baths</small></div>
  }

  <!-- المساحة دائماً تظهر لأنها أساسية لكل أنواع العقارات -->
  <div><i class="bi bi-aspect-ratio fs-4 d-block text-danger"></i> <span class="fw-bold">{{ prop.area }}</span> <small class="text-muted d-block small">m²</small></div>
  
  <div><i class="bi bi-building fs-4 d-block text-danger"></i> <span class="fw-bold text-truncate" style="max-width: 80px;">{{ prop.propertyType }}</span> <small class="text-muted d-block">Type</small></div>
        </div>

      <!-- كارت الوصف -->
  <h5 class="fw-bold mb-3 border-start border-danger border-4 ps-2">Description</h5>
  
  <!-- نطبق الكلاس description-collapsed فقط إذا كانت الحالة false -->
  <p class="text-muted lh-lg mb-1" 
     [class.description-collapsed]="!isDescriptionExpanded()"
     style="white-space: pre-line;">
    {{ prop.description }}
  </p>

  <!-- يظهر الزرار فقط إذا كان النص طويلاً (مثلاً أكثر من 150 حرف) -->
  @if (prop.description.length > 150) {
    <button type="button" class="see-more-btn" (click)="toggleDescription()">
      {{ isDescriptionExpanded() ? 'See less' : 'See full description' }}
      <i class="bi" [class.bi-chevron-up]="isDescriptionExpanded()" [class.bi-chevron-down]="!isDescriptionExpanded()"></i>
    </button>
  }
</div>


<!-- [جديد] كارت تقسيم أدوار الفيلا (يظهر فقط لو النوع Villa) -->
      @if (prop.propertyType === 'Villa') {
        <div class="bg-white p-4 rounded-4 shadow-sm border border-light mb-4 animate__animated animate__fadeIn">
          <h5 class="fw-bold mb-4 border-bottom pb-2"><i class="bi bi-layers-half me-2 text-danger"></i>Villa Layout</h5>
          <div class="row g-4 text-center">
            @if (prop.groundRooms > 0 || prop.groundBaths > 0) {
              <div class="col-md-4 border-end">
                <h6 class="fw-bold text-danger small text-uppercase">Ground Floor</h6>
                <div class="small fw-bold">{{ prop.groundRooms }} Rooms | {{ prop.groundBaths }} Baths</div>
                <div class="small text-muted">{{ prop.groundReception }} Reception Pcs</div>
              </div>
            }
            @if (prop.firstRooms > 0 || prop.firstBaths > 0) {
              <div class="col-md-4 border-end">
                <h6 class="fw-bold text-danger small text-uppercase">First Floor</h6>
                <div class="small fw-bold">{{ prop.firstRooms }} Rooms | {{ prop.firstBaths }} Baths</div>
                <div class="small text-muted">{{ prop.firstReception }} Reception Pcs</div>
              </div>
            }
            @if (prop.secondRooms > 0 || prop.secondBaths > 0) {
              <div class="col-md-4">
                <h6 class="fw-bold text-danger small text-uppercase">Second Floor</h6>
                <div class="small fw-bold">{{ prop.secondRooms }} Rooms | {{ prop.secondBaths }} Baths</div>
                <div class="small text-muted">{{ prop.secondReception }} Reception Pcs</div>
              </div>
            }
          </div>
        </div>
      }

      @if (prop.propertyType === 'Villa') {
  <div class="bg-white p-4 rounded-4 shadow-sm border border-light mb-4 animate__animated animate__fadeIn">
    <h5 class="fw-bold mb-4 border-bottom pb-2">
      <i class="bi bi-info-square me-2 text-danger"></i>Villa Specifications
    </h5>
    
    <div class="row g-4 text-center">
      <!-- 1. نوع المساحة -->
      @if (prop.areaType) {
        <div class="col-md-4 border-end">
          <h6 class="fw-bold text-muted small text-uppercase" style="letter-spacing: 1px;">Area Type</h6>
          <div class="text-danger fw-bold fs-5">{{ prop.areaType }}</div>
        </div>
      }

      <!-- 2. تصنيف الفيلا -->
      @if (prop.villaCategory) {
        <div class="col-md-4 border-end">
          <h6 class="fw-bold text-muted small text-uppercase" style="letter-spacing: 1px;">Villa Category</h6>
          <div class="text-danger fw-bold fs-5">{{ prop.villaCategory }}</div>
        </div>
      }

      <!-- 3. النوع الفرعي (Penthouse / Basement) -->
      @if (prop.villaSubType && prop.villaSubType !== 'null') {
        <div class="col-md-4">
          <h6 class="fw-bold text-muted small text-uppercase" style="letter-spacing: 1px;">Villa Type</h6>
          <div class="text-danger fw-bold fs-5">{{ prop.villaSubType }}</div>
        </div>
      }
    </div>
  </div>
}

      <!-- كارت المواصفات الفنية -->
      <div class="bg-white p-4 rounded-4 shadow-sm border border-light mb-4">
        <h5 class="fw-bold mb-4 border-bottom pb-2">Property Specifications</h5>
        <div class="row g-4">
          <div class="col-md-6 border-end-md">
            <ul class="list-unstyled mb-0">
        @if (prop.distanceFromLandmark) {
          <li class="mb-3 small">
            <i class="bi bi-geo text-danger me-2"></i> 
            <strong>Landmark:</strong> {{ prop.distanceFromLandmark }}
          </li>
        }

        
        <!-- إظهار الدور فقط لو أكبر من 0 -->
        @if (prop.floor > 0) {
          <li class="mb-3 small"><i class="bi bi-layers text-danger me-2"></i> <strong>Floor:</strong> {{ prop.floor }} @if(prop.totalFloors > 0) { of {{ prop.totalFloors }} }</li>
        }
       @if (prop.totalFloors > 2 && prop.propertyType !== 'Villa') {
  <li class="mb-3 small ">
    <strong><i class="bi bi-layers text-danger me-2"></i> Total Floors:</strong> 
    <span>{{ prop.totalFloors }}</span>
  </li>
}

<!-- 2. عدد الشقق في الدور -->
<!-- يظهر للمحلات والمكاتب والـ Full Floor فقط لو البروكر كتب رقم أكبر من 0 -->
<!-- ويختفي تماماً في حالة الفيلا -->
@if (prop.apartmentsPerFloor > 1 && prop.propertyType !== 'Villa') {
  <li class="mb-3 small ">
    <strong><i class="bi bi-people text-danger me-2"></i> Units per floor:</strong> 
    <span>{{ prop.apartmentsPerFloor }}</span>
  </li>
}

        

        @if (prop.buildYear > 0) {
          <li class="mb-3 small"><i class="bi bi-calendar-check text-danger me-2"></i> <strong>Built in:</strong> {{ prop.buildYear }}</li>
        }
      </ul>
    </div>

    <div class="col-md-6">
      <ul class="list-unstyled">
       @if (prop.view && prop.view !== 'string') {
          <li class="mb-3 small"><i class="bi bi-eye text-danger me-2"></i> <strong>View:</strong> {{ prop.view }}</li>
        }

        @if (prop.elevatorsCount > 0) {
          <li class="mb-3 small"><i class="bi bi-arrow-up-circle text-danger me-2"></i> <strong>Elevators:</strong> {{ prop.elevatorsCount }}</li>
        }

        @if (prop.receptionPieces > 0) {
           <li class="mb-3 small"><i class="bi bi-grid-3x3-gap text-danger me-2"></i> <strong>Reception:</strong> {{ prop.receptionPieces }} Pieces</li>
        }

        <li class="mb-3 small"><i class="bi bi-paint-bucket text-danger me-2"></i> <strong>Finishing:</strong> {{ prop.finishing }}</li>
              
              @if (prop.listingType !== 'Rent') {
                <li class="mb-3 small"><i class="bi bi-cash-stack text-danger me-2"></i> <strong>Commission:</strong> 2.5%</li>
              }
      </ul>
          </div>
        </div>

         @if (prop.listingType === 'Primary' || prop.listingType === 'ResaleProject') {
            <div class="alert alert-light border mt-2 py-3 small d-flex align-items-center shadow-sm">
                <i class="bi bi-truck text-danger me-3 fs-4"></i>
                <div>
                    <span class="d-block fw-bold text-dark">Handover Status: {{ prop.deliveryStatus }}</span>
                    @if (prop.deliveryYear) { <small class="d-block text-danger fw-bold">Expected completion by {{ prop.deliveryYear }}</small> }
                </div>
            </div>
        }

        <div class="mt-4 p-3 rounded-3 bg-danger-subtle border border-danger border-opacity-10 shadow-sm">
          <div class="d-flex align-items-center">
            <i class="bi bi-wallet2 fs-4 text-danger me-3"></i>
            <div>
              @if (prop.listingType === 'Rent') {
                <h6 class="mb-0 fw-bold">Rental Terms</h6>
                @if (prop.securityDeposit > 0) { <small class="text-danger fw-bold">Security Deposit: EGP {{ prop.securityDeposit | number }}</small> }
              } @else {
                <h6 class="mb-0 fw-bold">Payment Plan: {{ prop.paymentMethod }}</h6>
                @if (prop.paymentMethod === 'Installment') {
                   <div class="mt-1">
                      <small class="d-block text-dark"><strong>Installment Years:</strong> {{ prop.installmentYears }} Years</small>
                      @if (prop.downPayment > 0) {
                        <small class="d-block text-danger fw-bold">Down Payment: EGP {{ prop.downPayment | number }}</small>
                      }
                      @if (prop.quarterInstallment > 0) {
                        <small class="d-block text-danger fw-bold">Quarterly Installment: EGP {{ prop.quarterInstallment | number }}</small>
                      }
                   </div>
                } @else {
                    <small class="text-muted">Full cash payment </small>
                }
              }
            </div>
          </div>
        </div>

<br>
        <!-- قسم المميزات والخدمات (Key Features & Amenities) -->
<div class="mt-5">
  <h6 class="fw-bold small text-muted mb-4 " style="letter-spacing: 1px;">Key Features & Amenities</h6>
  
  <div class="row g-3 animate__animated animate__fadeInUp"> <!-- صف لتقسيم المساحة إلى عمودين -->
    
    <!-- العمود الأول: يحتوي على أول 5 عناصر (جهة اليسار) -->
    @if(prop.hasMasterRoom) { 
      <div class="col-md-6">
        <div class="d-flex align-items-center">
          <i class="bi bi-check2-circle text-danger fs-5 me-2"></i>
          <span class="text-dark fw-medium">Master Bedroom</span>
        </div>
      </div>
    }

    @if(prop.hasHotelEntrance) { 
      <div class="col-md-6">
        <div class="d-flex align-items-center">
          <i class="bi bi-check2-circle text-danger fs-5 me-2"></i>
          <span class="text-dark fw-medium">Hotel Entrance</span>
        </div>
      </div>
    }

    @if(prop.hasSecurity) { 
      <div class="col-md-6">
        <div class="d-flex align-items-center">
          <i class="bi bi-check2-circle text-danger fs-5 me-2"></i>
          <span class="text-dark fw-medium">24/7 Security</span>
        </div>
      </div>
    }

    @if(prop.hasParking) { 
      <div class="col-md-6">
        <div class="d-flex align-items-center">
          <i class="bi bi-check2-circle text-danger fs-5 me-2"></i>
          <span class="text-dark fw-medium">Parking Slot Available</span>
        </div>
      </div>
    }

    @if(prop.hasPool) { 
      <div class="col-md-6">
        <div class="d-flex align-items-center">
          <i class="bi bi-check2-circle text-danger fs-5 me-2"></i>
          <span class="text-dark fw-medium">Private Swimming Pool</span>
        </div>
      </div>
    }

    @if(prop.hasBalcony) { 
      <div class="col-md-6">
        <div class="d-flex align-items-center">
          <i class="bi bi-check2-circle text-danger fs-5 me-2"></i>
          <span class="text-dark fw-medium">Spacious Balcony</span>
        </div>
      </div>
    }

    @if(prop.isFirstOwner) { 
      <div class="col-md-6">
        <div class="d-flex align-items-center">
          <i class="bi bi-check2-circle text-danger fs-5 me-2"></i>
          <span class="text-dark fw-medium">First Owner</span>
        </div>
      </div>
    }

    @if(prop.hasLandShare) { 
      <div class="col-md-6">
        <div class="d-flex align-items-center">
          <i class="bi bi-check2-circle text-danger fs-5 me-2"></i>
          <span class="text-dark fw-medium">Ownership includes Land Share</span>
        </div>
      </div>
    }

    @if(prop.isLegalReconciled) { 
      <div class="col-md-6">
        <div class="d-flex align-items-center">
          <i class="bi bi-check2-circle text-danger fs-5 me-2"></i>
          <span class="text-dark fw-medium">Legal Reconciliation Available</span>
        </div>
      </div>
    }

    @if(prop.isLicensed) { 
      <div class="col-md-6">
        <div class="d-flex align-items-center">
          <i class="bi bi-check2-circle text-danger fs-5 me-2"></i>
          <span class="text-dark fw-medium">Licensed Residential Unit</span>
        </div>
      </div>
    }

    @if(prop.hasGarden) {
      <div class="col-md-6">
        <div class="d-flex align-items-center">
          <i class="bi bi-check2-circle text-danger fs-5 me-2"></i>
          <span class="text-dark fw-medium">Garden Area</span>
        </div>
      </div>
    }
  </div>
</div>

<!-- قسم المرافق (Utilities) المحدث -->
@if(prop.hasElectricityMeter || prop.hasWaterMeter || prop.hasGasMeter) {
  <div class="border-top pt-4 mt-4">
    <h6 class="fw-bold small text-muted mb-3 " style="letter-spacing: 1px;">Utilities Connected</h6>
    <div class="d-flex gap-2 flex-wrap">
      @if(prop.hasElectricityMeter) { 
        <span class="badge bg-light text-dark border px-3 py-2 small fw-normal shadow-sm">
          <i class="bi bi-lightning-charge text-warning me-1"></i> Electricity Meter
        </span> 
      }
      @if(prop.hasWaterMeter) { 
        <span class="badge bg-light text-dark border px-3 py-2 small fw-normal shadow-sm">
          <i class="bi bi-droplet text-primary me-1"></i> Water Meter
        </span> 
      }
      @if(prop.hasGasMeter) { 
        <span class="badge bg-light text-dark border px-3 py-2 small fw-normal shadow-sm">
          <i class="bi bi-fire text-danger me-1"></i> Natural Gas
        </span> 
      }
    </div>
  </div>
}
      </div>
    </div>

    

    <!-- العمود الأيمن (البروكر) -->
    <div class="col-lg-4">
      <div class="sticky-sidebar"> 
        <div class="card border-0 shadow rounded-4 p-4 text-center">
          <div class="bg-danger text-white rounded-circle d-inline-flex align-items-center justify-content-center mx-auto mb-3 shadow" style="width: 70px; height: 70px;">
            <i class="bi bi-person-badge fs-2"></i>
          </div>
          <h5 class="fw-bold mb-1">{{ prop.brokerName }}</h5>
          <p class="text-muted small mb-4">Real Estate Consultant</p>
          <a [href]="'tel:' + prop.brokerPhone" class="btn btn-outline-dark btn-lg w-100 rounded-pill mb-3 fw-bold py-2 small shadow-sm"><i class="bi bi-telephone-fill me-2"></i> Call Now</a>
          <a [href]="getWhatsAppLink(prop.brokerPhone)" target="_blank" class="btn btn-success btn-lg w-100 rounded-pill fw-bold py-2 small shadow"><i class="bi bi-whatsapp me-2"></i> WhatsApp</a>
        </div>
      </div>
    </div>

  </div>

  <!-- قسمProvided By (في آخر عمود التفاصيل col-lg-8) -->
<div class="bg-white p-4 rounded-4 shadow-sm border border-light mt-4 mb-5">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
    <div class="d-flex align-items-center">
      <div class="bg-danger-subtle text-danger rounded-circle p-3 me-3">
        <i class="bi bi-patch-check-fill fs-3"></i>
      </div>
      <div>
        <h4 class="fw-bold mb-0" style="font-size: 0.7rem; letter-spacing: 1px;">Provided By</h4>
        <h5 class="fw-bold mb-0">{{ prop.brokerName }}</h5>
      </div>
    </div>

    <!-- زرار عرض عقارات البروكر -->
    <button class="btn btn-outline-danger rounded-pill px-4 fw-bold shadow-sm"
            [routerLink]="['/home']" 
            [queryParams]="{ brokerId: prop.brokerId }">
      See agent properties ({{ prop.brokerPropertyCount }})
    </button>
  </div>
</div>

  <!-- المودال (الذي يفتح المعرض الكامل) -->
  <div class="modal fade" id="fullGalleryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content bg-dark border-0">
        <div class="modal-header border-0"><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
        <div class="modal-body p-2">
          <div id="modalCarousel" class="carousel slide">
            <div class="carousel-inner">
              @for (photo of prop.photos; track photo.url; let i = $index) {
                <div class="carousel-item" [class.active]="i === 0">
                  <img [src]="photo.url">
                </div>
              }
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#modalCarousel" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
            <button class="carousel-control-next" type="button" data-bs-target="#modalCarousel" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
}