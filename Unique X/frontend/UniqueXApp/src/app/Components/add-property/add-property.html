<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
        
        <!-- الهيدر -->
        <div class="bg-danger py-4 text-center">
          <h2 class="text-white fw-bold mb-0">List Your Property</h2>
          <p class="text-white-50 small mb-0">Fill in the details to reach thousands of buyers</p>
        </div>
        
        <div class="card-body p-4 p-md-5">
          <form [formGroup]="propertyForm" (ngSubmit)="onSubmit()">
            
            <!-- القسم الأول: المعلومات الأساسية -->
            <h5 class="fw-bold text-dark border-bottom pb-2 mb-4"><i class="bi bi-info-circle me-2 text-danger"></i>General Information</h5>
            
            <div class="row g-3 mb-4">
              <div class="col-md-4">
                <label class="form-label fw-bold small">Property Title</label>
                <input type="text" formControlName="title" class="form-control shadow-sm" placeholder="">
                @if (propertyForm.get('title')?.touched && propertyForm.get('title')?.invalid) {
                  <small class="text-danger d-block mt-1">Title is required</small>
                }
              </div>
              <div class="col-md-2">
    <label class="form-label fw-bold small">Code</label>
    <input type="text" formControlName="code" class="form-control shadow-sm" placeholder="e.g. AR#123">
  </div>
              <div class="col-md-3">
                <label class="form-label fw-bold small">Listing Type</label>
                <select formControlName="listingType" class="form-select shadow-sm">
                  <option [value]="0">Resale</option>
                  <option [value]="1">Rent</option>
                  <option [value]="2">Primary</option>
                  <option [value]="3">Resale Project</option>
                </select>
              </div>


              
              <div class="col-md-3">
                <label class="form-label fw-bold small">Property Type</label>
                <select formControlName="propertyType" class="form-select shadow-sm">
                  <option [value]="0">Apartment</option>
                  <option [value]="1">Villa</option>
                  <option [value]="2">Shop</option>
                  <option [value]="3">Office</option>
                  <option [value]="4">Chalet</option>
                  <option [value]="5">Full Floor</option>
                </select>
              </div>
            </div>

            @if (showDeliveryMenu()) {
  <div class="row g-3 mb-4 animate__animated animate__fadeIn">
    
    <!-- قائمة اختيار حالة التسليم -->
    <div class="col-md-6">
      <label class="form-label fw-bold small">Delivery Status</label>
      <select formControlName="deliveryStatus" class="form-select shadow-sm">
        <option [value]="0">Immediate Delivery (Ready)</option>
        <option [value]="1">Under Construction</option>
      </select>
    </div>

    <!-- حقل سنة التسليم: يظهر فقط لو اختار Under Construction -->
    @if (isUnderConstruction()) {
      <div class="col-md-6 animate__animated animate__fadeInRight">
        <label class="form-label fw-bold small">Delivery Year</label>
        <div class="input-group">
            <span class="input-group-text bg-white"><i class="bi bi-calendar-event"></i></span>
            <input type="text" (input)="formatInteger($event, 'deliveryYear')" formControlName="deliveryYear" class="form-control" 
                   [min]="currentYear" placeholder="e.g. 2027">
        </div>
        @if (propertyForm.get('deliveryYear')?.errors?.['min']) {
            <small class="text-danger">Delivery year cannot be in the past</small>
        }
      </div>
    }

  </div>
}

            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label fw-bold small">Total Price</label>
                <div class="input-group">
                  <span class="input-group-text bg-white">EGP</span>
                  <input type="text" (input)="formatFinancial($event, 'price')" formControlName="price" class="form-control" min="1000000" placeholder="1,000,000 EGP">
                </div>
                <!-- الجزء الجديد: خطأ السعر -->
               @if (propertyForm.get('price')?.touched && propertyForm.get('price')?.errors?.['min']) {
    <!-- الرسالة تتغير حسب النوع المختار -->
    <small class="text-danger d-block mt-1">
      Price must be at least {{ isRent() ? '1' : '1,000,000' }} EGP
    </small>
  }
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold small">Area (m²)</label>
                <div class="input-group">
                  <span class="input-group-text bg-white"><i class="bi bi-aspect-ratio"></i></span>
                  <input type="text" (input)="formatInteger($event, 'area')" formControlName="area" class="form-control" placeholder="">
                </div>
                <!-- الجزء الجديد: خطأ المساحة -->
                @if (propertyForm.get('area')?.touched && propertyForm.get('area')?.errors?.['min']) {
                  <small class="text-danger d-block mt-1">Area must be greater than 0</small>
                }
              </div>
            </div>

            <!-- القسم الثاني: مواصفات الوحدة -->
            <h5 class="fw-bold text-dark border-bottom pb-2 mb-4"><i class="bi bi-house-door me-2 text-danger"></i>Unit Specifications</h5>
            
            <div class="row g-3 mb-4 align-items-end">
              <div class="col-md-3">
                <label class="form-label fw-bold small">Rooms</label>
                  <input type="text" (input)="formatInteger($event, 'rooms')" formControlName="rooms" class="form-control" min="0">
                
              </div>
              <div class="col-md-3">
                <label class="form-label fw-bold small">Bathrooms</label>
                  <input type="text" (input)="formatInteger($event, 'bathrooms')" formControlName="bathrooms" class="form-control" min="0">
                
              </div>
              <div class="col-md-3">
                <label class="form-label fw-bold small">Reception Pieces</label>
                <input type="text" (input)="formatInteger($event, 'receptionPieces')" formControlName="receptionPieces" class="form-control" min="0">
                @if (propertyForm.get('receptionPieces')?.errors?.['min']) {
                  
                }
              </div>
              <div class="col-md-3">
                <label class="small fw-bold">Build Year</label>
                <!-- الجزء الجديد: منع سنة في المستقبل -->
                <input type="text" (input)="formatInteger($event, 'buildYear')" formControlName="buildYear" class="form-control" min="1950" [max]="currentYear">
                @if (propertyForm.get('buildYear')?.errors?.['max']) {
                  <small class="text-danger d-block mt-1">Year cannot exceed {{ currentYear }}</small>
                }
                @if (propertyForm.get('buildYear')?.errors?.['min']) {
                  <small class="text-danger d-block mt-1">Must be after 1950</small>
                }
              </div>

              <div class="col-md-5">
    <label class="form-label fw-bold small">Finishing Type</label>
    <select formControlName="finishing" class="form-select shadow-sm">
      <option [value]="0">Core and Shell</option>
      <option [value]="1">Semi-Finished</option>
      <option [value]="2">Fully Finished</option>
      <option [value]="3">Semi-Furnished</option>
      <option [value]="4">Fully Furnished</option>
    </select>
  </div>
  <div class="col-md-4">
                <label class="form-label fw-bold small">Landmark</label>
                <input type="text" formControlName="distanceFromLandmark" class="form-control shadow-sm" placeholder="">
              </div>
            </div>

            

            <!-- القسم الثالث: الموقع -->
            <h5 class="fw-bold text-dark border-bottom pb-2 mb-4"><i class="bi bi-geo-alt me-2 text-danger"></i>Location Details</h5>
            <div class="row g-3 mb-4">
              <div class="col-md-4">
                <label class="form-label fw-bold small">City</label>
                <select formControlName="city" class="form-select shadow-sm">
                  <option [value]="1">Cairo</option>
                  <option [value]="2">Alexandria</option>
                  <option [value]="3">North Coast</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-bold small">Region</label>
                <select formControlName="region" class="form-select shadow-sm">
                  <option value="">-- Select Region --</option>
                  @for (region of filteredRegions; track region) {
                    <option [value]="region">{{ region }}</option>
                  }
                </select>
              </div>

              @if (isProject()) {
    <div class="col-md-4 animate__animated animate__fadeIn">
      <label class="form-label fw-bold small text-dark">Project Name</label>
      <select formControlName="projectName" class="form-select shadow-sm">
        <option value="">-- Select Project --</option>
        @for (project of filteredProjects; track project) {
          <option [value]="project">{{ project }}</option>
        }
      </select>
    </div>
  }
              
            </div>

            <!-- القسم الرابع: تفاصيل المبنى -->
            <h5 class="fw-bold text-dark border-bottom pb-2 mb-4"><i class="bi bi-building me-2 text-danger"></i>Building Details</h5>
            <div class="row g-3 mb-4">
              <div class="col-md-3">
                <label class="small fw-bold">Total Floors</label>
                <input type="text" (input)="formatInteger($event, 'totalFloors')" formControlName="totalFloors" class="form-control" [min]="2">
                @if (propertyForm.get('totalFloors')?.errors?.['min']) {
                  
                }
              </div>
              <div class="col-md-3">
  <label class="small fw-bold">Floor Number</label>
  <input type="text" (input)="formatInteger($event, 'floor')" formControlName="floor" class="form-control" min="0" (change)="validateFloorInput()">
</div>
              
              
              <div class="col-md-3">
                <label class="small fw-bold">Units Per Floor</label>
                <input type="text" (input)="formatInteger($event, 'apartmentsPerFloor')" formControlName="apartmentsPerFloor" class="form-control" min="1">
                @if (propertyForm.get('apartmentsPerFloor')?.errors?.['min']) {
                  
                }
              </div>
              <div class="col-md-3">
                <label class="small fw-bold">Elevators Count</label>
                <input type="text" (input)="formatInteger($event, 'elevatorsCount')" formControlName="elevatorsCount" class="form-control" min="0">
                @if (propertyForm.get('elevatorsCount')?.errors?.['min']) {
                  
                }
              </div>
            </div>

            <div class="mb-4">
              <label class="small fw-bold">View </label>
              <input type="text" formControlName="view" class="form-control shadow-sm" placeholder="">
            </div>

            <!-- القسم الخامس: المميزات والحالات القانونية -->
            <!-- القسم الموحد: Licensing & Amenities -->
<h5 class="fw-bold text-dark border-bottom pb-2 mb-4">
  <i class="bi bi-shield-check me-2 text-danger"></i>Licensing & Amenities
</h5>

<div class="row g-3 mb-5">
  
  <!-- الصف الأول -->
  <div class="col-md-4">
    <div class="form-check form-switch p-3 border rounded-3 bg-light d-flex justify-content-between align-items-center shadow-sm h-100">
      <label class="form-check-label small fw-bold mb-0">Land Share</label>
      <input class="form-check-input ms-0" type="checkbox" formControlName="hasLandShare">
    </div>
  </div>
  <div class="col-md-4">
    <div class="form-check form-switch p-3 border rounded-3 bg-light d-flex justify-content-between align-items-center shadow-sm h-100">
      <label class="form-check-label small fw-bold mb-0">Licensed Unit</label>
      <input class="form-check-input ms-0" type="checkbox" formControlName="isLicensed">
    </div>
  </div>
  <div class="col-md-4">
    <div class="form-check form-switch p-3 border rounded-3 bg-light d-flex justify-content-between align-items-center shadow-sm h-100">
      <label class="form-check-label small fw-bold mb-0">Legal Reconciled</label>
      <input class="form-check-input ms-0" type="checkbox" formControlName="isLegalReconciled">
    </div>
  </div>

  <!-- الصف الثاني -->
  <div class="col-md-4">
    <div class="form-check form-switch p-3 border rounded-3 bg-light d-flex justify-content-between align-items-center shadow-sm h-100">
      <label class="form-check-label small fw-bold mb-0">First Owner</label>
      <input class="form-check-input ms-0" type="checkbox" formControlName="isFirstOwner">
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="form-check form-switch p-3 border rounded-3 bg-light d-flex justify-content-between align-items-center shadow-sm h-100">
      <label class="form-check-label small fw-bold mb-0">Master Room</label>
      <input class="form-check-input ms-0" type="checkbox" formControlName="hasMasterRoom">
    </div>
  </div>
  <div class="col-md-4">
    <div class="form-check form-switch p-3 border rounded-3 bg-light d-flex justify-content-between align-items-center shadow-sm h-100">
      <label class="form-check-label small fw-bold mb-0">Hotel Entrance</label>
      <input class="form-check-input ms-0" type="checkbox" formControlName="hasHotelEntrance">
    </div>
  </div>
  <!-- الصف الثالث -->
   <div class="col-md-4">
    <div class="form-check form-switch p-3 border rounded-3 bg-light d-flex justify-content-between align-items-center shadow-sm h-100">
      <label class="form-check-label small fw-bold mb-0">24/7 Security</label>
      <input class="form-check-input ms-0" type="checkbox" formControlName="hasSecurity">
    </div>
  </div>
  <div class="col-md-4">
    <div class="form-check form-switch p-3 border rounded-3 bg-light d-flex justify-content-between align-items-center shadow-sm h-100">
      <label class="form-check-label small fw-bold mb-0">Parking Slot</label>
      <input class="form-check-input ms-0" type="checkbox" formControlName="hasParking">
    </div>
  </div>
  <div class="col-md-4">
    <div class="form-check form-switch p-3 border rounded-3 bg-light d-flex justify-content-between align-items-center shadow-sm h-100">
      <label class="form-check-label small fw-bold mb-0">Balcony</label>
      <input class="form-check-input ms-0" type="checkbox" formControlName="hasBalcony">
    </div>
  </div>
  

  <!-- الصف الرابع -->
  

  <div class="col-md-4">
    <div class="form-check form-switch p-3 border rounded-3 bg-light d-flex justify-content-between align-items-center shadow-sm h-100">
      <label class="form-check-label small fw-bold mb-0">Electricity Meter</label>
      <input class="form-check-input ms-0" type="checkbox" formControlName="hasElectricityMeter">
    </div>
  </div>
  <div class="col-md-4">
    <div class="form-check form-switch p-3 border rounded-3 bg-light d-flex justify-content-between align-items-center shadow-sm h-100">
      <label class="form-check-label small fw-bold mb-0">Water Meter</label>
      <input class="form-check-input ms-0" type="checkbox" formControlName="hasWaterMeter">
    </div>
  </div>

  <div class="col-md-4">
    <div class="form-check form-switch p-3 border rounded-3 bg-light d-flex justify-content-between align-items-center shadow-sm h-100">
      <label class="form-check-label small fw-bold mb-0">Natural Gas Meter</label>
      <input class="form-check-input ms-0" type="checkbox" formControlName="hasGasMeter">
    </div>
  </div>

</div>

            <!-- القسم السادس: الدفع -->
<!-- ================== حالة البيع والمشاريع (Resale / Primary) ================== -->
<h5 class="fw-bold border-bottom pb-2 mb-4 text-danger">
  <i class="bi bi-wallet2 me-2"></i>Pricing & Payment Information
</h5>

<div class="row g-3 mb-4 align-items-start">
  
  <!-- ================== الحالة الأولى: الإيجار (Rent) ================== -->
  @if (isRent()) {
    <div class="col-md-6 animate__animated animate__fadeIn">
      <label class="small fw-bold">Monthly Rent Amount</label>
      <input type="text" (input)="formatFinancial($event, 'monthlyRent')" formControlName="monthlyRent" class="form-control shadow-sm border-danger" min="0">
     <small class="text-muted" style="font-size: 0.7rem;">* This should match the total price field above</small>
    </div>
    <div class="col-md-6 animate__animated animate__fadeIn">
      <label class="small fw-bold">Security Deposit</label>
      <input type="text" (input)="formatFinancial($event, 'securityDeposit')" formControlName="securityDeposit" class="form-control shadow-sm border-danger" min="0">
    @if (isSecurityExceeded()) {
        <small class="text-danger d-block mt-1 animate__animated animate__shakeX">
          Security deposit cannot exceed the rent amount
        </small>
      }
    </div>
  }

  <!-- ================== الحالة الثانية: البيع (Resale / Project) ================== -->
  @else {
    <!-- 1. اختيار طريقة الدفع -->
    <div class="col-md-3">
      <label class="small fw-bold">Payment Method</label>
      <select formControlName="paymentMethod" class="form-select shadow-sm">
        <option value="Cash">Full Cash</option>
        <option value="Installment">Installment Plan</option>
      </select>
    </div>

    <!-- 2. لو اختار تقسيط (Installment) -->
    @if (isInstallment()) {
      
      <!-- لو هو مشروع (Primary أو Resale Project) نعرض الـ 3 حقول جنب بعض -->
      @if (isProject()) {
        <div class="col-md-9 animate__animated animate__fadeIn">
          <div class="row g-2">
            <!-- سنوات التقسيط -->
            <div class="col-md-4">
              <label class="small fw-bold">Installment Years</label>
              <input type="text" (input)="formatInteger($event, 'installmentYears')" formControlName="installmentYears" class="form-control shadow-sm" min="1">
              @if (propertyForm.get('installmentYears')?.errors?.['min']) {
                <small class="text-danger d-block">Min 1 year</small>
              }
            </div>

            <!-- المقدم -->
            <div class="col-md-4">
              <label class="small fw-bold">Down Payment</label>
              <input type="text" (input)="formatFinancial($event, 'downPayment')" formControlName="downPayment" class="form-control shadow-sm" min="0">
              <!-- شرط: المقدم أقل من السعر الكلي -->
              @if (isFinanceExceeded('downPayment')) {
        <small class="text-danger d-block mt-1 animate__animated animate__shakeX">
          Cannot exceed Total Price
        </small>
      }
            </div>

            <!-- القسط الربع سنوي -->
            <div class="col-md-4">
              <label class="small fw-bold">Quarterly Installment</label>
              <input type="text" (input)="formatFinancial($event, 'quarterInstallment')" formControlName="quarterInstallment" class="form-control shadow-sm" min="0">
              <!-- شرط: القسط أقل من السعر الكلي -->
              @if (isFinanceExceeded('quarterInstallment')) {
        <small class="text-danger d-block mt-1 animate__animated animate__shakeX">
          Cannot exceed Total Price
        </small>
      }
            </div>
          </div>
        </div>
      } 
      
      <!-- لو هو Resale عادي (مش مشروع) نكتفي بسنوات التقسيط فقط في سطر واحد -->
      @else {
        <div class="col-md-4 animate__animated animate__fadeIn">
          <label class="small fw-bold">Years of Installment</label>
          <input type="text" (input)="formatInteger($event, 'installmentYears')" formControlName="installmentYears" class="form-control shadow-sm" min="1">
        </div>
      }
    }
  }
</div>

            <!-- الميديا والوصف -->
            <h5 class="fw-bold text-dark border-bottom pb-2 mb-4"><i class="bi bi-images me-2 text-danger"></i>Media Gallery</h5>
            <div class="upload-box border border-dashed rounded-4 p-4 text-center bg-light mb-4 shadow-sm">
  <i class="bi bi-cloud-arrow-up fs-1 text-danger d-block mb-2"></i>
  <input type="file" (change)="onFileSelect($event)" multiple class="form-control mx-auto" style="max-width: 400px;" accept="image/*">
  
  <!-- نص توضيحي محدث -->
  <p class="text-muted small mt-2">
    Click on a photo below to set it as <b>Main</b> <br>
    <span class="text-danger fw-bold fs-7 uppercase">* Maximum 10 photos allowed per listing</span>
  </p>
</div>

            <!-- معاينة الصور -->
            <div class="row g-3 mb-4">
              @for (photo of selectedPhotos(); track $index) {
                <div class="col-md-3 col-6">
                  <div class="photo-preview-card position-relative rounded-3 overflow-hidden shadow-sm border"
                       [class.main-selected]="mainPhotoIndex === $index" (click)="setMainPhoto($index)">
                    <img [src]="photo.preview" class="w-100 object-fit-cover" style="height: 140px;">
                    @if (mainPhotoIndex === $index) {
                      <div class="main-badge bg-danger text-white px-2 py-1 small position-absolute top-0 start-0">MAIN</div>
                    }
                    <button type="button" class="btn-remove-photo" (click)="removePhoto($index); $event.stopPropagation()">
                      <i class="bi bi-x-circle-fill text-white fs-5"></i>
                    </button>
                  </div>
                </div>
              }
            </div>

            <div class="mb-4">
              <label class="form-label fw-bold small">Detailed Description</label>
              <textarea formControlName="description" class="form-control shadow-sm" rows="5" placeholder="Finishing details, special view..."></textarea>
            </div>

            <!-- زر النشر -->
            <div class="d-grid mt-4">
              <button type="submit" [disabled]="propertyForm.invalid || isSubmitting" class="btn btn-danger btn-lg rounded-pill py-3 fw-bold shadow">
                @if (isSubmitting) {
                  <span class="spinner-border spinner-border-sm me-2"></span> Publishing Your Ad...
                } @else {
                  <i class="bi bi-megaphone-fill me-2"></i> Publish My Listing
                }
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
</div>