<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
        
        <!-- الهيدر الموحد -->
        <div class="bg-danger py-4 text-center">
          <h2 class="text-white fw-bold mb-0">Edit Property</h2>
          <p class="text-white-50 small mb-0">Update your listing details to keep it accurate</p>
        </div>
        
        <div class="card-body p-4 p-md-5">
          <form [formGroup]="editForm" (ngSubmit)="onSubmit()">
            
            <!-- القسم الأول: المعلومات العامة -->
            <h5 class="fw-bold text-dark border-bottom pb-2 mb-4"><i class="bi bi-info-circle me-2 text-danger"></i>General Information</h5>
            
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label fw-bold small">Property Title</label>
                <input type="text" formControlName="title" class="form-control shadow-sm">
                @if (editForm.get('title')?.touched && editForm.get('title')?.invalid) {
                  <small class="text-danger d-block mt-1">Title is required</small>
                }
              </div>
              <div class="col-md-3">
                <label class="form-label fw-bold small">Listing Type</label>
                <select formControlName="listingType" class="form-select shadow-sm">
                  <option [value]="0">Resale</option>
                  <option [value]="1">Rent</option>
                  <option [value]="2">Primary</option>
                  <option [value]="3">Resale Project</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-bold small">Property Type</label>
                <select formControlName="propertyType" class="form-select shadow-sm">
                  <option [value]="0">Apartment</option>
                  <option [value]="1">Villa</option>
                  <option [value]="2">Shop</option>
                  <option [value]="3">Office</option>
                  <option [value]="4">Chalet</option>
                </select>
              </div>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label fw-bold small">Price (EGP)</label>
                <div class="input-group">
                  <span class="input-group-text bg-white">EGP</span>
                  <input type="number" formControlName="price" class="form-control" min="1">
                </div>
                @if (editForm.get('price')?.touched && editForm.get('price')?.errors?.['min']) {
                  <small class="text-danger d-block mt-1">Price must be greater than 0</small>
                }
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold small">Area (m²)</label>
                <div class="input-group">
                  <span class="input-group-text bg-white"><i class="bi bi-aspect-ratio"></i></span>
                  <input type="number" formControlName="area" class="form-control" min="1">
                </div>
                @if (editForm.get('area')?.touched && editForm.get('area')?.errors?.['min']) {
                  <small class="text-danger d-block mt-1">Area must be greater than 0</small>
                }
              </div>
            </div>

            <!-- القسم الثاني: المواصفات الداخلية -->
            <h5 class="fw-bold text-dark border-bottom pb-2 mb-4"><i class="bi bi-house-door me-2 text-danger"></i>Unit Specifications</h5>
            
            <div class="row g-3 mb-4">
              <div class="col-md-3">
                <label class="form-label fw-bold small">Rooms</label>
                <div class="input-group input-group-sm shadow-sm">
                  <button class="btn btn-outline-secondary" type="button" (click)="updateCounter('rooms', -1)">-</button>
                  <input type="number" formControlName="rooms" class="form-control text-center bg-white" readonly>
                  <button class="btn btn-outline-secondary" type="button" (click)="updateCounter('rooms', 1)">+</button>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-bold small">Bathrooms</label>
                <div class="input-group input-group-sm shadow-sm">
                  <button class="btn btn-outline-secondary" type="button" (click)="updateCounter('bathrooms', -1)">-</button>
                  <input type="number" formControlName="bathrooms" class="form-control text-center bg-white" readonly>
                  <button class="btn btn-outline-secondary" type="button" (click)="updateCounter('bathrooms', 1)">+</button>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-bold small">Reception Pieces</label>
                <input type="number" formControlName="receptionPieces" class="form-control shadow-sm" min="0">
                @if (editForm.get('receptionPieces')?.errors?.['min']) {
                  
                }
              </div>
              <div class="col-md-3">
                <label class="form-label fw-bold small">Floor Number</label>
                <input type="number" formControlName="floor" class="form-control shadow-sm" min="0">
                @if (editForm.get('floor')?.errors?.['min']) {
                  
                }
              </div>
            </div>

            <!-- القسم الثالث: الموقع -->
            <h5 class="fw-bold text-dark border-bottom pb-2 mb-4"><i class="bi bi-geo-alt me-2 text-danger"></i>Location Details</h5>
            
            <div class="row g-3 mb-4">
              <div class="col-md-4">
                <label class="form-label fw-bold small">City</label>
                <select formControlName="city" class="form-select shadow-sm">
                  <option [value]="1">Cairo</option>
                  <option [value]="2">Alexandria</option>
                  <option [value]="3">North Coast</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-bold small">Region</label>
                <select formControlName="region" class="form-select shadow-sm">
                  @for (region of filteredRegions; track region) {
                    <option [value]="region">{{ region }}</option>
                  }
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-bold small">Landmark</label>
                <input type="text" formControlName="distanceFromLandmark" class="form-control shadow-sm">
              </div>
            </div>

            <!-- القسم الرابع: تفاصيل المبنى -->
            <h5 class="fw-bold text-dark border-bottom pb-2 mb-4"><i class="bi bi-building me-2 text-danger"></i>Building Details</h5>
            
            <div class="row g-3 mb-4">
              <div class="col-md-3">
                <label class="small fw-bold">Build Year</label>
                <input type="number" formControlName="buildYear" class="form-control shadow-sm" [max]="2026">
                @if (editForm.get('buildYear')?.errors?.['max']) {
                  <small class="text-danger d-block mt-1">Cannot exceed 2026</small>
                }
              </div>
              <div class="col-md-3">
                <label class="small fw-bold">Total Floors</label>
                <input type="number" formControlName="totalFloors" class="form-control shadow-sm" min="2">
                @if (editForm.get('totalFloors')?.errors?.['min']) {
                  
                }
              </div>
              <div class="col-md-3">
                <label class="small fw-bold">Units Per Floor</label>
                <input type="number" formControlName="apartmentsPerFloor" class="form-control shadow-sm" min="1">
                @if (editForm.get('apartmentsPerFloor')?.errors?.['min']) {
                  
                }
              </div>
              <div class="col-md-3">
                <label class="small fw-bold">Elevators Count</label>
                <input type="number" formControlName="elevatorsCount" class="form-control shadow-sm" min="0">
                @if (editForm.get('elevatorsCount')?.errors?.['min']) {
                  
                }
              </div>
            </div>

            <div class="mb-4">
                <label class="small fw-bold">View</label>
                <input type="text" formControlName="view" class="form-control shadow-sm">
            </div>

            <!-- القسم الخامس: المميزات والحالات القانونية -->
            <h5 class="fw-bold text-dark border-bottom pb-2 mb-4"><i class="bi bi-shield-check me-2 text-danger"></i>Status & Amenities</h5>
            
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <div class="form-check form-switch p-3 border rounded-3 bg-light d-flex justify-content-between align-items-center shadow-sm">
                  <label class="form-check-label small fw-bold mb-0" for="firstOwner">First Owner</label>
                  <input class="form-check-input ms-0" type="checkbox" formControlName="isFirstOwner" id="firstOwner">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check form-switch p-3 border rounded-3 bg-light d-flex justify-content-between align-items-center shadow-sm">
                  <label class="form-check-label small fw-bold mb-0" for="reconciled">Legal Reconciled</label>
                  <input class="form-check-input ms-0" type="checkbox" formControlName="isLegalReconciled" id="reconciled">
                </div>
              </div>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-md-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" formControlName="hasMasterRoom" id="master"><label class="form-check-label small fw-bold" for="master">Master Room</label></div></div>
              <div class="col-md-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" formControlName="hasHotelEntrance" id="entrance"><label class="form-check-label small fw-bold" for="entrance">Hotel Entrance</label></div></div>
              <div class="col-md-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" formControlName="hasSecurity" id="security"><label class="form-check-label small fw-bold" for="security">24/7 Security</label></div></div>
              <div class="col-md-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" formControlName="hasParking" id="parking"><label class="form-check-label small fw-bold" for="parking">Parking Slot</label></div></div>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-md-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" formControlName="hasBalcony" id="balcony"><label class="form-check-label small fw-bold" for="balcony">Has Balcony</label></div></div>
              <div class="col-md-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" formControlName="isFurnished" id="furnished"><label class="form-check-label small fw-bold" for="furnished">Is Furnished</label></div></div>
            </div>

            <!-- القسم السادس: الدفع -->
            <h5 class="fw-bold border-bottom pb-2 mb-4 text-danger"><i class="bi bi-credit-card me-2"></i>Payment Information</h5>
            <div class="row g-3 mb-4 align-items-start">
              <div class="col-md-6">
                <label class="small fw-bold">Payment Method</label>
                <select formControlName="paymentMethod" class="form-select shadow-sm">
                  <option value="Cash">Full Cash</option>
                  <option value="Installment">Installment</option>
                </select>
              </div>

              @if (isInstallmentSelected()) {
                <div class="col-md-6 animate__animated animate__fadeIn">
                  <label class="small fw-bold">Installment Duration (Years)</label>
                  <input type="number" formControlName="installmentYears" class="form-control shadow-sm" min="1">
                  @if (editForm.get('installmentYears')?.errors?.['min']) {
                    <small class="text-danger d-block mt-1">Must be at least 1 year</small>
                  }
                </div>
              }
            </div>

            <!-- القسم السابع: الميديا والوصف -->
            <h5 class="fw-bold text-dark border-bottom pb-2 mb-4"><i class="bi bi-images me-2 text-danger"></i>Photos & Description</h5>
            
            <!-- عرض الصور الحالية مع إمكانية تحديد الـ Main -->
            @if (existingPhotos().length > 0) {
              <h6 class="fw-bold small text-muted mb-3">Current Photos (Click to set as Main)</h6>
              <div class="row g-2 mb-4">
                @for (photo of existingPhotos(); track photo.id) {
                  <div class="col-md-2 col-4">
                    <div class="position-relative rounded-3 overflow-hidden border cursor-pointer shadow-sm"
                         [class.border-danger]="photo.isMain" [style.border-width]="photo.isMain ? '3px' : '1px'"
                         (click)="!photo.isMain ? setExistingAsMain(photo.id) : null">
                      <img [src]="photo.url" class="w-100 object-fit-cover" style="height: 100px;">
                      @if (photo.isMain) {
                        <span class="badge bg-danger position-absolute top-0 start-0 m-1" style="font-size: 0.6rem;">MAIN</span>
                      } @else {
                        <div class="photo-overlay d-flex align-items-center justify-content-center">
                           <i class="bi bi-star text-white"></i>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            }

            <!-- إضافة صور جديدة -->
            <div class="upload-box border border-dashed rounded-4 p-4 text-center bg-light mb-4 shadow-sm">
              <label class="small fw-bold d-block mb-2 text-muted">ADD NEW PHOTOS</label>
              <input type="file" (change)="onFileSelect($event)" multiple class="form-control mx-auto shadow-sm" style="max-width: 400px;" accept="image/*">
            </div>

            <div class="row g-2 mb-4">
              @for (photo of selectedPhotos(); track $index) {
                <div class="col-md-2 col-4">
                  <div class="position-relative rounded-3 overflow-hidden border shadow-sm cursor-pointer"
                       [class.border-danger]="newMainPhotoIndex === $index" (click)="setNewAsMain($index)">
                    <img [src]="photo.preview" class="w-100 object-fit-cover" style="height: 100px;">
                    @if (newMainPhotoIndex === $index) {
                      <span class="badge bg-danger position-absolute top-0 start-0 m-1" style="font-size: 0.6rem;">NEW MAIN</span>
                    }
                  </div>
                </div>
              }
            </div>

            <div class="mb-4">
              <label class="form-label fw-bold small">Detailed Description</label>
              <textarea formControlName="description" class="form-control shadow-sm" rows="5"></textarea>
            </div>

            <!-- أزرار الحفظ والإلغاء -->
            <div class="d-grid gap-2 pt-3">
              <button type="submit" [disabled]="editForm.invalid" class="btn btn-danger btn-lg rounded-pill fw-bold py-3 shadow">
                <i class="bi bi-check-circle me-2"></i> Save Property Changes
              </button>
              <a routerLink="/my-properties" class="btn btn-dark btn-lg rounded-pill fw-bold py-3 shadow text-decoration-none text-center">
                Discard Changes
              </a>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
</div>